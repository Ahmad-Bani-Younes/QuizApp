<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>الاختبار</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #0d47a1;
      --secondary-color: #1976d2;
      --success-color: #2e7d32;
      --danger-color: #c62828;
      --warning-color: #f9a825;
      --text-color: #333;
      --light-gray: #f5f5f5;
      --white: #ffffff;
      --border-radius: 12px;
      --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }

    body {
      font-family: 'Tajawal', Arial, sans-serif;
      background-color: var(--light-gray);
      color: var(--text-color);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    .main-container {
      display: flex;
      max-width: 1200px;
      width: 100%;
      gap: 20px;
    }

    .container {
      flex: 1;
      background: var(--white);
      border-radius: var(--border-radius);
      padding: 30px;
      box-shadow: var(--box-shadow);
      transition: var(--transition);
    }

    .container:hover {
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }

    #timer {
      text-align: center;
      font-size: 18px;
      margin-bottom: 25px;
      background: #e3f2fd;
      padding: 12px;
      border-radius: var(--border-radius);
      color: var(--primary-color);
      font-weight: bold;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
    }

    #timer i {
      font-size: 20px;
    }

    #quiz-question {
      text-align: center;
      font-size: 22px;
      color: var(--primary-color);
      margin-bottom: 25px;
      line-height: 1.5;
      font-weight: 600;
    }

    .question-number {
      text-align: center;
      color: #666;
      font-size: 16px;
      margin-bottom: 15px;
      background: #f5f5f5;
      padding: 8px;
      border-radius: 20px;
      display: inline-block;
      width: auto;
      margin-left: auto;
      margin-right: auto;
      display: block;
    }

    .option {
      background-color: #f9f9f9;
      padding: 18px 20px;
      margin: 12px 0;
      border-radius: var(--border-radius);
      border: 2px solid #e0e0e0;
      cursor: pointer;
      transition: var(--transition);
      font-size: 18px;
      display: flex;
      align-items: center;
    }

    .option:hover {
      border-color: var(--secondary-color);
      background-color: #e3f2fd;
      transform: translateX(-5px);
    }

    .option input[type="radio"] {
      margin-left: 12px;
      transform: scale(1.3);
      accent-color: var(--primary-color);
      cursor: pointer;
    }

    .option label {
      cursor: pointer;
      flex: 1;
    }

    .buttons-container {
      display: flex;
      gap: 15px;
      margin-top: 30px;
    }

    button {
      padding: 14px 25px;
      color: white;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 18px;
      font-weight: 600;
      transition: var(--transition);
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .btn-primary {
      background: var(--primary-color);
    }

    .btn-primary:hover {
      background: #1565c0;
    }

    .btn-danger {
      background: var(--danger-color);
    }

    .btn-danger:hover {
      background: #b71c1c;
    }

    .sidebar {
      width: 180px;
      background: var(--white);
      border-radius: var(--border-radius);
      padding: 20px;
      box-shadow: var(--box-shadow);
      position: sticky;
      top: 20px;
      height: fit-content;
    }

    .sidebar-title {
      text-align: center;
      font-weight: bold;
      margin-bottom: 15px;
      font-size: 18px;
      color: var(--primary-color);
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }

    .question-nav {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }

    .question-box {
      width: 40px;
      height: 40px;
      background-color: #e0e0e0;
      color: #666;
      display: flex;
      justify-content: center;
      align-items: center;
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition);
      font-weight: 500;
    }

    .question-box:hover {
      background-color: #bdbdbd;
    }

    .question-box.active {
      background-color: var(--primary-color);
      color: white;
      font-weight: bold;
      transform: scale(1.1);
    }

    .question-box.answered {
      background-color: var(--success-color);
      color: white;
    }

    .progress-container {
      margin-top: 20px;
      background: #f0f0f0;
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      background: var(--primary-color);
      transition: width 0.5s ease;
    }

    .progress-text {
      text-align: center;
      margin-top: 10px;
      font-size: 14px;
      color: #666;
    }

    /* Dark Mode Styles */
    body.dark-mode {
      background-color: #121212;
      color: #e0e0e0;
    }

    body.dark-mode .container,
    body.dark-mode .sidebar {
      background-color: #1e1e1e;
      color: #e0e0e0;
    }

    body.dark-mode #timer {
      background-color: #0d2b4e;
      color: #e0e0e0;
    }

    body.dark-mode #quiz-question {
      color: #64b5f6;
    }

    body.dark-mode .option {
      background-color: #2d2d2d;
      border-color: #444;
      color: #e0e0e0;
    }

    body.dark-mode .option:hover {
      background-color: #1a3a5a;
      border-color: #1976d2;
    }

    body.dark-mode .question-box {
      background-color: #333;
      color: #e0e0e0;
    }

    body.dark-mode .question-box:hover {
      background-color: #444;
    }

    body.dark-mode .progress-container {
      background-color: #333;
    }

    /* Responsive Design */
    @media (max-width: 992px) {
      .main-container {
        flex-direction: column-reverse;
      }
      
      .sidebar {
        width: 100%;
        position: static;
        margin-bottom: 20px;
      }
      
      .question-nav {
        justify-content: flex-start;
      }
    }

    @media (max-width: 576px) {
      body {
        padding: 10px;
      }
      
      .container {
        padding: 20px;
      }
      
      #quiz-question {
        font-size: 20px;
      }
      
      .option {
        padding: 15px;
        font-size: 16px;
      }
      
      .buttons-container {
        flex-direction: column;
        gap: 10px;
      }
    }
  </style>
</head>
<body>


<!-- ✅ الأصوات -->
<audio id="error-sound" src="https://www.soundjay.com/button/sounds/beep-08b.mp3" preload="auto"></audio>
<audio id="success-sound" src="https://www.soundjay.com/button/sounds/button-10.mp3" preload="auto"></audio>
<audio id="click-sound" src="https://www.soundjay.com/button/sounds/button-16.mp3" preload="auto"></audio>
<audio id="alert-sound" src="https://www.soundjay.com/button/sounds/beep-07.mp3" preload="auto"></audio>

<div class="main-container">
  <div class="sidebar">
    <div class="sidebar-title">
      <i class="fas fa-list-ol"></i> الأسئلة
    </div>
    <div class="question-nav" id="questionNav"></div>
    <div class="progress-container">
      <div class="progress-bar" id="progressBar"></div>
    </div>
    <div class="progress-text" id="progressText">0% مكتمل</div>
  </div>

  <div class="container">
    <div id="timer"><i class="fas fa-clock"></i> الوقت المتبقي: <span id="time">--:--</span></div>
    <div class="question-number" id="question-number">السؤال 1</div>
    <h2 id="quiz-question">تحميل السؤال...</h2>
    <div id="options-container"></div>
    <div class="buttons-container">
      <button class="btn-primary" onclick="playClick(); nextQuestion()"><i class="fas fa-arrow-left"></i> التالي</button>
      <button class="btn-danger" onclick="playAlert(); confirmFinish()"><i class="fas fa-stop"></i> إنهاء الاختبار</button>
    </div>
  </div>
</div>
 <script src="main.js"></script>
<script>
  const email = sessionStorage.getItem("email");
  const currentTestId = sessionStorage.getItem("current_test_id");
  if (!email || !currentTestId) {
    playError();
    alert("يرجى تسجيل الدخول واختيار اختبار أولاً");
    window.location.href = "login.html";
  }

  let currentTest = null;
  let questions = [];
  let currentQuestion = 0;
  let score = 0;
  let timeLeft = 0;
  let timerInterval;
  let quizFinished = false;
  const timerElement = document.getElementById("time");
  const questionNav = document.getElementById("questionNav");
  const progressBar = document.getElementById("progressBar");
  const progressText = document.getElementById("progressText");
  const TESTS_API = "https://6844373271eb5d1be032b52a.mockapi.io/tests";

  async function loadTestFromApi() {
    try {
      const res = await fetch(`${TESTS_API}/${currentTestId}`);
      if (!res.ok) throw new Error("فشل تحميل الاختبار");
      currentTest = await res.json();
      startQuiz(currentTest);
    } catch {
      playError();
      alert("❌ لم يتم العثور على الاختبار أو حدث خطأ أثناء التحميل.");
      window.location.href = "apply-test.html";
    }
  }

  function startQuiz(test) {
    const allQuestions = test.questions || [];
    timeLeft = test.duration * 60;
    questions = getRandomQuestions(allQuestions, Math.min(20, allQuestions.length));
    questions.forEach(q => {
      q.correct = q.correct ?? q.correctIndex;
    });
    sessionStorage.setItem("questions", JSON.stringify(questions));

    timerInterval = setInterval(() => {
      const minutes = Math.floor(timeLeft / 60);
      const seconds = timeLeft % 60;
      timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      timeLeft--;
      if (timeLeft === 60) {
        playAlert();
        alert("⚠️ لديك دقيقة واحدة متبقية فقط!");
      }
      if (timeLeft < 0) {
        playAlert();
        clearInterval(timerInterval);
        finishQuiz();
      }
    }, 1000);

    loadQuestion();
  }

  function getRandomQuestions(all, count) {
    return [...all].sort(() => 0.5 - Math.random()).slice(0, count);
  }

  function updateSidebar() {
    questionNav.innerHTML = "";
    questions.forEach((q, index) => {
      const box = document.createElement("div");
      box.className = "question-box" + (index === currentQuestion ? " active" : "") + (q.selected !== undefined ? " answered" : "");
      box.textContent = index + 1;
      box.onclick = () => { playClick(); currentQuestion = index; loadQuestion(); };
      questionNav.appendChild(box);
    });
    const answeredCount = questions.filter(q => q.selected !== undefined).length;
    const progress = Math.round((answeredCount / questions.length) * 100);
    progressBar.style.width = `${progress}%`;
    progressText.textContent = `${progress}% مكتمل`;
  }

  function loadQuestion() {
    updateSidebar();
    const q = questions[currentQuestion];
    document.getElementById("quiz-question").textContent = q.question;
    document.getElementById("question-number").textContent = `السؤال ${currentQuestion + 1} من ${questions.length}`;
    const container = document.getElementById("options-container");
    container.innerHTML = "";
    q.options.forEach((opt, i) => {
      const div = document.createElement("div");
      div.className = "option";
      div.innerHTML = `<input type="radio" name="option" value="${i}" id="option-${i}" ${q.selected === i ? 'checked' : ''}><label for="option-${i}">${opt}</label>`;
      container.appendChild(div);
    });
  }

  function nextQuestion() {
    const selected = document.querySelector('input[name="option"]:checked');
    if (!selected) return alert("يرجى اختيار إجابة");
    const val = parseInt(selected.value);
    const q = questions[currentQuestion];
    q.selected = val;
    if (val === (q.correct ?? q.correctIndex)) {
      score++;
      playSuccess();
    } else {
      playError();
    }
    currentQuestion++;
    if (currentQuestion < questions.length) loadQuestion();
    else finishQuiz();
  }

  async function finishQuiz() {
    if (quizFinished) return;
    quizFinished = true;
    clearInterval(timerInterval);
    const resultData = {
        testId: currentTestId,
      score,
      total: questions.length,
      questions: questions.map(q => ({
        question: q.question,
        selected: q.selected,
        correct: q.correct ?? q.correctIndex,
        options: q.options
      })),
      timestamp: new Date().toISOString()
    };
    const userId = sessionStorage.getItem('userId');
    if (userId) {
      try {
        await fetch(`https://6844373271eb5d1be032b52a.mockapi.io/users/${userId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ latestResult: resultData })
        });
      } catch (err) {
        console.error('فشل حفظ النتيجة:', err);
      }
    }
    sessionStorage.setItem('last_score', score);
    sessionStorage.setItem('total_questions', questions.length);
    sessionStorage.setItem('questions', JSON.stringify(questions));
    sessionStorage.setItem('latest_result', JSON.stringify(resultData));

    window.location.href = 'result.html';
  }

  function confirmFinish() {
    const unanswered = questions.length - questions.filter(q => q.selected !== undefined).length;
    if (unanswered > 0 && !confirm(`⚠️ ${unanswered} أسئلة بدون إجابة. هل تريد إنهاء الاختبار؟`)) return;
    finishQuiz();
  }

  document.addEventListener("visibilitychange", () => {
    if (document.hidden && !quizFinished) {
      alert("🚫 لا يُسمح بالخروج من صفحة الاختبار.");
      finishQuiz();
    }
  });

  function playSuccess() { document.getElementById("success-sound").play(); }
  function playError() { document.getElementById("error-sound").play(); }
  function playClick() { document.getElementById("click-sound").play(); }
  function playAlert() { document.getElementById("alert-sound").play(); }

  loadTestFromApi();
</script>
</body>
</html>

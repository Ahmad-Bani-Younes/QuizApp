<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      font-family: 'Tajawal', sans-serif;
      background-color: #f0f2f5;
      margin: 0;
      padding: 20px;
    }

    h1 {
      text-align: center;
      color: #4f46e5;
    }

    .users-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin-top: 30px;
    }

    .user-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      width: 250px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      text-align: center;
      transition: 0.3s;
    }

    .user-card:hover {
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
      transform: translateY(-3px);
    }

    .user-card img {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 15px;
    }

    .user-card h3 {
      margin: 10px 0;
      font-size: 18px;
      color: #333;
    }

    .add-btn {
      background-color: #4f46e5;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
    }

    .add-btn:hover {
      background-color: #4338ca;
    }

    .logout {
      position: fixed;
      top: 20px;
      left: 20px;
      padding: 10px 20px;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .logout:hover {
      background: #dc2626;
    }
  </style>
</head>
<body>
    <div id="navbar-placeholder"></div>
  <script src="main.js"></script>

<h1>Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ Ø§Ù„Ù…Ù‚ØªØ±Ø­ÙŠÙ†</h1>
<button class="logout" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
<div class="users-container" id="usersContainer"></div>

<script>
const USERS_API = "https://6844373271eb5d1be032b52a.mockapi.io/users";
const FRIENDS_API = "https://68458d2ffc51878754dba0bb.mockapi.io/friends";
const currentUserId = sessionStorage.getItem("userId");

if (!currentUserId) {
  alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ù‹Ø§.");
  window.location.href = "login.html";
}

let allFriends = [];

async function fetchUsersAndFriends() {
  const [usersRes, friendsRes] = await Promise.all([
    fetch(USERS_API),
    fetch(FRIENDS_API)
  ]);

  const users = await usersRes.json();
  allFriends = await friendsRes.json();

  const filteredUsers = users.filter(user =>
    user.id !== currentUserId &&
    user.role !== "admin"
  );

  displayUsers(filteredUsers);
}

function getFriendStatus(friendId) {
  const sent = allFriends.find(f => f.userId === currentUserId && f.friendId === friendId);
  const received = allFriends.find(f => f.userId === friendId && f.friendId === currentUserId);

  if (sent && received) return "friend";
  if (sent && !received) return "pending";
  if (!sent && received) return "confirm";
  return "add";
}


function displayUsers(users) {
  const container = document.getElementById("usersContainer");
  container.innerHTML = "";

  users.forEach(user => {
    const status = getFriendStatus(user.id);

    let btnHtml = "";
    if (status === "add") {
      btnHtml = `<button class="add-btn" onclick="sendFriendRequest('${user.id}', '${user.name}')">Ø£Ø¶Ù ÙƒØµØ¯ÙŠÙ‚</button>`;
    } else if (status === "pending") {
      btnHtml = `<button class="add-btn" disabled>Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</button>`;
    } else if (status === "confirm") {
      btnHtml = `<button class="add-btn" onclick="confirmFriend('${user.id}', '${user.name}')">Ù‚Ø¨ÙˆÙ„ Ø§Ù„ØµØ¯Ø§Ù‚Ø©</button>`;
    } else {
      btnHtml = `<button class="add-btn" disabled>ØµØ¯ÙŠÙ‚ âœ…</button>`;
    }

    const statusText = 
      status === "friend" ? "ğŸ¤ ØµØ¯ÙŠÙ‚" :
      status === "pending" ? "ğŸ•“ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±" :
      status === "confirm" ? "ğŸ’Œ Ø·Ù„Ø¨ ÙˆØ§Ø±Ø¯" :
      "ğŸ‘¤ Ù„ÙŠØ³ ØµØ¯ÙŠÙ‚Ù‹Ø§";

    const card = document.createElement("div");
    card.className = "user-card";
    card.innerHTML = `
      <img src="${user.imageData || 'https://via.placeholder.com/100'}" alt="${user.name}">
      <h3>${user.name}</h3>
      <p style="color: gray; font-size: 13px;">${statusText}</p>
      ${btnHtml}
    `;
    container.appendChild(card);
  });
}


async function sendFriendRequest(friendId, friendName) {
  try {
    await fetch(FRIENDS_API, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        userId: currentUserId,
        friendId: friendId,
        createdAt: new Date().toISOString()
      })
    });
    alert(`âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØµØ¯Ø§Ù‚Ø© Ø¥Ù„Ù‰ ${friendName}`);
    fetchUsersAndFriends(); // ØªØ­Ø¯ÙŠØ«
  } catch (err) {
    console.error(err);
    alert("âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨");
  }
}
async function confirmFriend(friendId, friendName) {
  try {
    const existing = allFriends.find(f =>
      f.userId === friendId && f.friendId === currentUserId
    );

    const alreadyConfirmed = allFriends.find(f =>
      f.userId === currentUserId && f.friendId === friendId
    );

    if (alreadyConfirmed) {
      alert("âš ï¸ ØªÙ… ØªØ£ÙƒÙŠØ¯ Ù‡Ø°Ù‡ Ø§Ù„ØµØ¯Ø§Ù‚Ø© Ù…Ù† Ù‚Ø¨Ù„.");
      return;
    }

    if (existing) {
      // ÙÙ‚Ø· Ù†ÙƒÙ…Ù„ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø© Ø¨Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¹ÙƒØ³ÙŠ
      await fetch(FRIENDS_API, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          userId: currentUserId,
          friendId: friendId,
          createdAt: new Date().toISOString()
        })
      });

      alert(`âœ… ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØµØ¯Ø§Ù‚Ø© Ù…Ø¹ ${friendName}`);
      fetchUsersAndFriends();
    } else {
      alert("âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨ ØµØ¯Ø§Ù‚Ø© ÙˆØ§Ø±Ø¯ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….");
    }
  } catch (err) {
    console.error(err);
    alert("âŒ ÙØ´Ù„ ÙÙŠ ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØµØ¯Ø§Ù‚Ø©");
  }
}



function logout() {
  sessionStorage.clear();
  window.location.href = "login.html";
}

fetchUsersAndFriends();
</script>

</body>
</html>
